---
# Homebrew installation and configuration

- name: Check if Homebrew is installed
  ansible.builtin.stat:
    path: "{{ brew_prefix }}/bin/brew"
  register: homebrew_check

- name: Install Homebrew
  when: not homebrew_check.stat.exists
  block:
    - name: Create Homebrew directory
      ansible.builtin.file:
        path: "{{ brew_prefix }}"
        state: directory
        owner: "{{ ansible_facts['user_id'] }}"
        group: "{{ ansible_facts['user_id'] }}"
        mode: "0755"
      become: true

    - name: Download and extract Homebrew
      ansible.builtin.shell: |
        set -o pipefail
        curl -fsSL https://github.com/Homebrew/brew/tarball/master | tar xz --strip 1 -C {{ brew_prefix }}
      args:
        executable: /bin/bash
      changed_when: true

- name: Add Homebrew to bash profile (immediate config)
  ansible.builtin.blockinfile:
    path: "{{ ansible_facts['user_dir'] }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - HOMEBREW"
    block: |
      eval "$({{ brew_prefix }}/bin/brew shellenv)"
    create: true
    mode: "0644"
  register: bashrc_updated
  notify: Remind shell reload

- name: Set brew facts for subsequent tasks
  ansible.builtin.set_fact:
    brew_prefix: "{{ brew_prefix }}"
    brew_bin: "{{ brew_bin }}"
    homebrew_installed: true

- name: Update Homebrew
  ansible.builtin.command: "{{ brew_bin }} update"
  environment:
    PATH: "{{ brew_prefix }}/bin:{{ ansible_facts['env']['PATH'] }}"
  changed_when: false

- name: Display Homebrew version
  ansible.builtin.command: "{{ brew_bin }} --version"
  register: brew_version
  environment:
    PATH: "{{ brew_prefix }}/bin:{{ ansible_facts['env']['PATH'] }}"
  changed_when: false

- name: Show Homebrew version
  ansible.builtin.debug:
    msg: "{{ brew_version.stdout_lines[0] }}"
  when: brew_version is defined and brew_version.stdout_lines | length > 0
