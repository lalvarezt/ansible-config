---
# Homebrew installation and configuration

- name: Check if Homebrew is installed
  stat:
    path: "{{ brew_prefix }}/bin/brew"
  register: homebrew_check

- name: Install Homebrew
  shell: |
    /bin/bash -c "$(curl -fsSL {{ brew_install_script }})"
  when: not homebrew_check.stat.exists
  environment:
    NONINTERACTIVE: "1"

- name: Add Homebrew to bash profile (immediate config)
  blockinfile:
    path: "{{ ansible_user_dir }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - HOMEBREW"
    block: |
      eval "$({{ brew_prefix }}/bin/brew shellenv)"
    create: true
  register: bashrc_updated
  notify: Remind shell reload

- name: Set brew facts for subsequent tasks
  set_fact:
    brew_prefix: "{{ brew_prefix }}"
    brew_bin: "{{ brew_bin }}"
    homebrew_installed: true

- name: Update Homebrew
  command: "{{ brew_bin }} update"
  environment:
    PATH: "{{ brew_prefix }}/bin:{{ ansible_env.PATH }}"
  changed_when: false

- name: Display Homebrew version
  command: "{{ brew_bin }} --version"
  register: brew_version
  environment:
    PATH: "{{ brew_prefix }}/bin:{{ ansible_env.PATH }}"
  changed_when: false

- name: Show Homebrew version
  debug:
    msg: "{{ brew_version.stdout_lines[0] }}"
  when: brew_version is defined and brew_version.stdout_lines | length > 0
