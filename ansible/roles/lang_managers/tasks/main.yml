---
# Language package managers installation

- name: Install uv via Homebrew
  ansible.builtin.command: "{{ brew_bin }} install --quiet uv"
  environment:
    PATH: "{{ brew_prefix }}/bin:{{ ansible_facts['env']['PATH'] }}"
  args:
    creates: "{{ brew_prefix }}/bin/uv"

- name: Install go via Homebrew
  ansible.builtin.command: "{{ brew_bin }} install --quiet go"
  environment:
    PATH: "{{ brew_prefix }}/bin:{{ ansible_facts['env']['PATH'] }}"
  args:
    creates: "{{ brew_prefix }}/bin/go"

- name: Check if rustup is installed
  ansible.builtin.stat:
    path: "{{ ansible_facts['user_dir'] }}/.cargo/bin/rustup"
  register: rustup_check

- name: Install Rust via rustup
  ansible.builtin.shell: |
    set -o pipefail
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  args:
    executable: /bin/bash
  when: not rustup_check.stat.exists
  changed_when: true

- name: Set language manager facts
  ansible.builtin.set_fact:
    uv_bin: "{{ brew_prefix }}/bin/uv"
    go_bin: "{{ brew_prefix }}/bin/go"
    cargo_bin: "{{ ansible_facts['user_dir'] }}/.cargo/bin/cargo"
    rustup_bin: "{{ ansible_facts['user_dir'] }}/.cargo/bin/rustup"

- name: Verify UV installation
  ansible.builtin.command: "{{ uv_bin }} --version"
  register: uv_version
  environment:
    PATH: "{{ brew_prefix }}/bin:{{ ansible_facts['env']['PATH'] }}"
  changed_when: false

- name: Verify Go installation
  ansible.builtin.command: "{{ go_bin }} version"
  register: go_version
  environment:
    PATH: "{{ brew_prefix }}/bin:{{ ansible_facts['env']['PATH'] }}"
  changed_when: false

- name: Verify Rust installation
  ansible.builtin.command: "{{ cargo_bin }} --version"
  register: cargo_version
  environment:
    PATH: "{{ ansible_facts['user_dir'] }}/.cargo/bin:{{ ansible_facts['env']['PATH'] }}"
  changed_when: false

- name: Display language manager versions
  ansible.builtin.debug:
    msg:
      - "UV: {{ uv_version.stdout }}"
      - "Go: {{ go_version.stdout }}"
      - "Cargo: {{ cargo_version.stdout }}"

# Environment setup (merged from env_setup role)
- name: Create temporary environment setup for bash
  ansible.builtin.blockinfile:
    path: "{{ ansible_facts['user_dir'] }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - TEMP ENV (will be replaced by chezmoi)"
    block: |
      # Temporary environment setup for installation phase
      # This will be replaced when chezmoi applies final config

      # Cargo/Rust
      [ -f "$HOME/.cargo/env" ] && source "$HOME/.cargo/env"

      # Go
      export GOPATH="$HOME/go"
      export PATH="$GOPATH/bin:$PATH"

      # UV tools
      export PATH="$HOME/.local/bin:$PATH"
    create: true
    mode: "0644"

- name: Set unified PATH fact for Ansible tasks
  ansible.builtin.set_fact:
    ansible_path: "{{ brew_prefix }}/bin:{{ ansible_facts['user_dir'] }}/.cargo/bin:{{ ansible_facts['user_dir'] }}/go/bin:{{ ansible_facts['user_dir'] }}/.local/bin:{{ ansible_facts['env']['PATH'] }}"

- name: Display configured PATH
  ansible.builtin.debug:
    msg: "Unified PATH for package installation: {{ ansible_path }}"
