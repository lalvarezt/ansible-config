---
# Language package managers installation

- name: Install uv via Homebrew
  ansible.builtin.command: "{{ brew_bin }} install --quiet uv"
  environment:
    PATH: "{{ brew_prefix }}/bin:{{ ansible_env.PATH }}"
  args:
    creates: "{{ brew_prefix }}/bin/uv"

- name: Install go via Homebrew
  ansible.builtin.command: "{{ brew_bin }} install --quiet go"
  environment:
    PATH: "{{ brew_prefix }}/bin:{{ ansible_env.PATH }}"
  args:
    creates: "{{ brew_prefix }}/bin/go"

- name: Check if rustup is installed
  ansible.builtin.stat:
    path: "{{ ansible_user_dir }}/.cargo/bin/rustup"
  register: rustup_check

- name: Install Rust via rustup
  ansible.builtin.shell: |
    set -o pipefail
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  args:
    executable: /bin/bash
  when: not rustup_check.stat.exists
  changed_when: true

- name: Set language manager facts
  ansible.builtin.set_fact:
    uv_bin: "{{ brew_prefix }}/bin/uv"
    go_bin: "{{ brew_prefix }}/bin/go"
    cargo_bin: "{{ ansible_user_dir }}/.cargo/bin/cargo"
    rustup_bin: "{{ ansible_user_dir }}/.cargo/bin/rustup"

- name: Verify UV installation
  ansible.builtin.command: "{{ uv_bin }} --version"
  register: uv_version
  environment:
    PATH: "{{ brew_prefix }}/bin:{{ ansible_env.PATH }}"
  changed_when: false

- name: Verify Go installation
  ansible.builtin.command: "{{ go_bin }} version"
  register: go_version
  environment:
    PATH: "{{ brew_prefix }}/bin:{{ ansible_env.PATH }}"
  changed_when: false

- name: Verify Rust installation
  ansible.builtin.command: "{{ cargo_bin }} --version"
  register: cargo_version
  environment:
    PATH: "{{ ansible_user_dir }}/.cargo/bin:{{ ansible_env.PATH }}"
  changed_when: false

- name: Display language manager versions
  ansible.builtin.debug:
    msg:
      - "UV: {{ uv_version.stdout }}"
      - "Go: {{ go_version.stdout }}"
      - "Cargo: {{ cargo_version.stdout }}"
