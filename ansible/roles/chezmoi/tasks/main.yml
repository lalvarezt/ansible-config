---
# Chezmoi initialization and application (FINAL CONFIG)

- name: Check if chezmoi is installed
  ansible.builtin.command: which chezmoi
  register: chezmoi_check
  failed_when: false
  changed_when: false
  environment:
    PATH: "{{ ansible_path }}"

- name: Install chezmoi via Homebrew (if not present)
  ansible.builtin.command: "{{ brew_bin }} install --quiet chezmoi"
  environment:
    PATH: "{{ ansible_path }}"
  when: chezmoi_check.rc != 0
  changed_when: true

- name: Check if chezmoi is already initialized
  ansible.builtin.stat:
    path: "{{ ansible_facts['user_dir'] }}/.local/share/chezmoi/.git"
  register: chezmoi_init_check

- name: Set chezmoi applied fact
  ansible.builtin.set_fact:
    chezmoi_was_applied: "{{ not chezmoi_init_check.stat.exists }}"

- name: Initialize chezmoi with SSH
  ansible.builtin.command: chezmoi init {{ chezmoi_repo_url }}
  when: not chezmoi_init_check.stat.exists
  environment:
    PATH: "{{ ansible_path }}"
  changed_when: true

- name: Apply chezmoi configuration (FINAL CONFIG - overrides temp env)
  ansible.builtin.command: chezmoi apply
  environment:
    PATH: "{{ ansible_path }}"
  when: not chezmoi_init_check.stat.exists
  changed_when: true

- name: Display chezmoi completion message
  ansible.builtin.debug:
    msg: "Chezmoi has applied the final configuration. Any temporary environment variables set during installation are now superseded by chezmoi-managed configs."
  when: not chezmoi_init_check.stat.exists
