---
# Chezmoi initialization and application (FINAL CONFIG)

- name: Check if chezmoi is installed
  command: which chezmoi
  register: chezmoi_check
  ignore_errors: true
  changed_when: false
  environment:
    PATH: "{{ ansible_path }}"

- name: Install chezmoi via Homebrew (if not present)
  command: "{{ brew_bin }} install --quiet chezmoi"
  environment:
    PATH: "{{ ansible_path }}"
  when: chezmoi_check.rc != 0

- name: Check if chezmoi is already initialized
  stat:
    path: "{{ ansible_user_dir }}/.local/share/chezmoi/.git"
  register: chezmoi_init_check

- name: Initialize chezmoi with SSH
  command: chezmoi init git@gitlab.com:lalvarezt/chezmoi.git
  when: not chezmoi_init_check.stat.exists
  environment:
    PATH: "{{ ansible_path }}"

- name: Apply chezmoi configuration (FINAL CONFIG - overrides temp env)
  command: chezmoi apply
  environment:
    PATH: "{{ ansible_path }}"

- name: Display chezmoi completion message
  debug:
    msg: "Chezmoi has applied the final configuration. Any temporary environment variables set during installation are now superseded by chezmoi-managed configs."
