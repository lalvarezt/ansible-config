---
# Post-configuration tasks (run at the very end)

- name: Check if bat is installed
  command: which bat
  environment:
    PATH: "{{ ansible_path }}"
  register: bat_check
  failed_when: false
  changed_when: false

- name: Build bat cache
  command: bat cache --build
  environment:
    PATH: "{{ ansible_path }}"
  when: bat_check.rc == 0
  register: bat_cache_result
  failed_when: false
  changed_when: bat_cache_result.rc == 0

- name: Check if update-alternatives exists
  command: which update-alternatives
  register: update_alternatives_check
  failed_when: false
  changed_when: false

- name: Check if neovim is installed
  command: which nvim
  environment:
    PATH: "{{ ansible_path }}"
  register: nvim_check
  failed_when: false
  changed_when: false

- name: Set neovim as default editor (if update-alternatives exists)
  block:
    - name: Check current editor alternative
      shell: readlink -f /etc/alternatives/editor 2>/dev/null || echo "none"
      register: current_editor
      changed_when: false

    - name: Install neovim as editor alternative
      command: sudo update-alternatives --install /usr/bin/editor editor "{{ nvim_check.stdout }}" 1
      when: "'nvim' not in current_editor.stdout"

    - name: Set neovim as default editor
      command: sudo update-alternatives --set editor "{{ nvim_check.stdout }}"
      when: "'nvim' not in current_editor.stdout"
  environment:
    PATH: "{{ ansible_path }}"
  when:
    - update_alternatives_check.rc == 0
    - nvim_check.rc == 0

- name: Check if systemd is available
  command: systemctl --version
  register: systemd_check
  failed_when: false
  changed_when: false

- name: Check if ghostty service exists
  stat:
    path: "{{ ansible_user_dir }}/.config/systemd/user/app-com.mitchellh.ghostty.service"
  register: ghostty_service_check
  when:
    - systemd_check.rc == 0
    - not (is_wsl | default(false))

- name: Enable ghostty systemd service (if systemctl available)
  systemd:
    name: app-com.mitchellh.ghostty.service
    enabled: true
    scope: user
  when:
    - systemd_check.rc == 0
    - not (is_wsl | default(false))
    - ghostty_service_check.stat.exists | default(false)

# IMPORTANT: Unlink Python at the very end to avoid breaking dependencies during installation
- name: Check if Python is linked in Homebrew
  command: "{{ brew_bin }} list python"
  environment:
    PATH: "{{ ansible_path }}"
  register: python_linked_check
  failed_when: false
  changed_when: false

- name: Unlink Python from Homebrew (prevents conflicts with system Python)
  command: "{{ brew_bin }} unlink python"
  environment:
    PATH: "{{ ansible_path }}"
  when: python_linked_check.rc == 0
  register: python_unlink_result
  failed_when: false
  changed_when: python_unlink_result.rc == 0

- name: Display final message
  debug:
    msg: |
      Bootstrap complete!

      IMPORTANT: You should now:
      1. Log out and log back in (or open a new terminal)
      2. Your shell configuration from chezmoi is now active
      3. All temporary environment variables have been replaced
      4. Homebrew Python has been unlinked to prevent conflicts

      To switch to fish shell (if installed):
      chsh -s $(which fish)
