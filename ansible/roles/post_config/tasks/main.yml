---
# Post-configuration tasks (run at the very end)

- name: Check if bat is installed
  ansible.builtin.command: which bat
  environment:
    PATH: "{{ ansible_path }}"
  register: bat_check
  failed_when: false
  changed_when: false

- name: Build bat cache
  ansible.builtin.command: bat cache --build
  environment:
    PATH: "{{ ansible_path }}"
  when: bat_check.rc == 0
  register: bat_cache_result
  failed_when: false
  changed_when: false

- name: Check if update-alternatives exists
  ansible.builtin.command: which update-alternatives
  register: update_alternatives_check
  failed_when: false
  changed_when: false

- name: Check if neovim is installed
  ansible.builtin.command: which nvim
  environment:
    PATH: "{{ ansible_path }}"
  register: nvim_check
  failed_when: false
  changed_when: false

- name: Set neovim as default editor (if update-alternatives exists)
  environment:
    PATH: "{{ ansible_path }}"
  when:
    - update_alternatives_check.rc == 0
    - nvim_check.rc == 0
  block:
    - name: Check current editor alternative
      ansible.builtin.shell: readlink -f /etc/alternatives/editor 2>/dev/null || echo "none"
      register: current_editor
      changed_when: false

    - name: Install neovim as editor alternative
      ansible.builtin.command: update-alternatives --install /usr/bin/editor editor "{{ nvim_check.stdout }}" 1
      when: "'nvim' not in current_editor.stdout"
      changed_when: true
      become: true

    - name: Set neovim as default editor
      ansible.builtin.command: update-alternatives --set editor "{{ nvim_check.stdout }}"
      when: "'nvim' not in current_editor.stdout"
      changed_when: true
      become: true

- name: Check if systemd is available
  ansible.builtin.command: systemctl --version
  register: systemd_check
  failed_when: false
  changed_when: false

- name: Check if ghostty service exists
  ansible.builtin.stat:
    path: "{{ ansible_facts['user_dir'] }}/.config/systemd/user/app-com.mitchellh.ghostty.service"
  register: ghostty_service_check
  when:
    - systemd_check.rc == 0
    - not (is_wsl | default(false))

- name: Enable ghostty systemd service (if systemctl available)
  ansible.builtin.systemd:
    name: app-com.mitchellh.ghostty.service
    enabled: true
    scope: user
  when:
    - systemd_check.rc == 0
    - not (is_wsl | default(false))
    - ghostty_service_check.stat.exists | default(false)

# IMPORTANT: Unlink Python at the very end to avoid breaking dependencies during installation
- name: Check if Python is linked in Homebrew
  ansible.builtin.command: "{{ brew_bin }} list python"
  environment:
    PATH: "{{ ansible_path }}"
  register: python_linked_check
  failed_when: false
  changed_when: false

- name: Unlink Python from Homebrew (prevents conflicts with system Python)
  ansible.builtin.command: "{{ brew_bin }} unlink python"
  environment:
    PATH: "{{ ansible_path }}"
  when: python_linked_check.rc == 0
  register: python_unlink_result
  failed_when: false
  changed_when: python_unlink_result.stdout is not search('0 symlinks removed')

- name: Display final message
  ansible.builtin.debug:
    msg: |
      Bootstrap complete!

      IMPORTANT: You should now:
      1. Log out and log back in (or open a new terminal)
      {% if chezmoi_was_applied | default(false) %}
      2. Your shell configuration from chezmoi is now active
      3. All temporary environment variables have been replaced
      {% endif %}
      {{ '2' if not chezmoi_was_applied | default(false) else '4' }}. Homebrew Python has been unlinked to prevent conflicts

      To switch to fish shell (if installed):
      chsh -s $(which fish)
